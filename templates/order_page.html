<!DOCTYPE html>
<html>
<head>
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <h2>–¢–æ–≤–∞—Ä—ã:</h2>
    <ul id="items">
        {% for item in items %}
            <li>
                {{ item.name }} - {{ item.price }} {{ item.currency }}
                <button onclick="addToOrder({{ item.id }})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–∫–∞–∑</button>
            </li>
        {% endfor %}
    </ul>

    <h2>–°–∫–∏–¥–∫–∏</h2>
    <ul id="discounts">
        {% for discount in discounts %}
            <li>
                {{ discount.name }} - {{ discount.percent }}
                <button onclick="addToOrder({{ discount.id }})">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
            </li>
        {% endfor %}
    </ul>

    <h2>–ù–∞–ª–æ–≥–∏</h2>
    <ul id="tax">
        {% for t in tax %}
            <li>
                {{ t.name }} - {{ t.percent }}
                <button onclick="addToOrder({{ t.id }})">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞–ª–æ–≥</button>
            </li>
        {% endfor %}
    </ul>

    <hr>
    <button onclick="createOrder()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    <p id="order-info">–ó–∞–∫–∞–∑ –Ω–µ —Å–æ–∑–¥–∞–Ω</p>

    <h3>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑:</h3>
    <ul id="order-items"></ul>

    <button id="pay-button" onclick="payOrder()" disabled>–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑</button>

    <script>
        let orderId = null;

        async function createOrder() {
            const response = await fetch('/order/create/', { method: 'POST' });
            const data = await response.json();
            orderId = data.order_id;
            document.getElementById('order-info').textContent = `–ó–∞–∫–∞–∑ ‚Ññ${orderId} —Å–æ–∑–¥–∞–Ω`;
            loadOrder();
        }

        async function addToOrder(itemId) {
            if (!orderId) {
                alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!");
                return;
            }
            await fetch(`/order/${orderId}/add/${itemId}/`, { method: 'POST' });
            loadOrder();
        }

        async function addDiscountToOrder(discountId) {
            if (!orderId) {
                alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!");
                return;
            }
            await fetch(`/order/${orderId}/add-discount/${discountId}/`, { method: 'POST' });
            loadOrder();
        }

        async function addTaxToOrder(taxId) {
            if (!orderId) {
                alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!");
                return;
            }
            await fetch(`/order/${orderId}/add-tax/${taxId}/`, { method: 'POST' });
            loadOrder();
        }

        async function loadOrder() {
            if (!orderId) return;
            const response = await fetch(`/order/${orderId}/`);
            const data = await response.json();

            const orderItems = document.getElementById('order-items');
            orderItems.innerHTML = '';
            data.items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} - ${item.price}`;
                orderItems.appendChild(li);
            });

            document.getElementById('pay-button').disabled = data.items.length === 0;
        }

        async function payOrder() {
            const response = await fetch(`/buy-order/${orderId}/`);
            if (!response.ok) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –æ–ø–ª–∞—Ç—ã");
                return;
            }
            const data = await response.json();
            const stripe = Stripe("{{ public_key }}");
            const result = await stripe.redirectToCheckout({ sessionId: data.session_id });
            if (result.error) {
                alert(result.error.message);
            }
        }

    </script>
</body>
</html>
